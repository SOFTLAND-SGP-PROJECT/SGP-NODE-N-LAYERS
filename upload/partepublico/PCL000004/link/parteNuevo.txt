CREATE PROCEDURE [dbo].[SLSPWEB_RegistraParte]  
 ---- ADD THE PARAMETERS FOR THE STORED PROCEDURE HERE     
 @NROCTA VARCHAR(6)  
 ,@VERSIO VARCHAR(6)  
 ,@USERID VARCHAR(40)  
 ,@DESCRP VARCHAR(MAX)  
 ,@ADJUNT VARCHAR(MAX)  
 ,@MODOBJ VARCHAR(255) = NULL  
 ,@CODOBJ VARCHAR(255) = NULL  
 ,@CODIMP VARCHAR(255) = NULL  
 ,@CODOCU VARCHAR(255) = NULL  
 ,@CODSUB VARCHAR(255) = 'C'  
 ,@TIPCLA VARCHAR(255) = 'SQL'  
AS  
BEGIN  
 DECLARE @UPDATED_SPCFOR TABLE (NROFOR INT NULL)  
 DECLARE @OUT_FCRMVH TABLE (  
  MODFOR VARCHAR(2)  
  ,CODFOR VARCHAR(6)  
  ,NROFOR INT  
  )  
 DECLARE @MODFOR VARCHAR(255)  
 DECLARE @CODFOR VARCHAR(255)  
 DECLARE @NROFOR INT  
 DECLARE @APLARE VARCHAR(255)  
 DECLARE @APLCOD VARCHAR(255)  
 DECLARE @ASGARE VARCHAR(255)  
 DECLARE @ASGRES VARCHAR(255)  
 DECLARE @ORIARE VARCHAR(255)  
 DECLARE @ORIRES VARCHAR(255)  
 DECLARE @PEDARE VARCHAR(255)  
 DECLARE @PEDRES VARCHAR(255)  
 DECLARE @USERNT VARCHAR(255)  
  
 SET @MODFOR = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_MODFOR', 'SP')  
 SET @CODFOR = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_CODFOR', 'CL')  
 SET @APLARE = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_APLARE', 'DES')  
 SET @APLCOD = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_APLCOD', 'GR')  
 SET @ASGARE = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_ASGARE', 'SOP')  
 SET @ASGRES = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_ASGRES', 'SOP')  
/* SET @CODSUB = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_CODSUB', 'C')*/  
 SET @ORIARE = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_ORIARE', 'VTA')  
 SET @ORIRES = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_ORIRES', 'CL')  
 SET @PEDARE = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_PEDARE', 'VTA')  
 SET @PEDRES = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_PEDRES', 'CL')  
 SET @USERNT = [DBO].[SLSPWEB_ASKPARAM]('DESASP', 'SP_WEB_USERNT', 'WEB')  
  
 --BEGIN TRY    
 BEGIN TRAN  
  
 UPDATE SPCFOR  
 SET SPCFOR_ULTNRO = SPCFOR_ULTNRO + 1  
  ,SPCFOR_FECMOD = GETDATE()  
 OUTPUT INSERTED.SPCFOR_ULTNRO  
 INTO @UPDATED_SPCFOR  
 WHERE SPCFOR_MODFOR = 'SP'  
  AND SPCFOR_CODFOR = @CODFOR  
  
 INSERT INTO SPRMVH (  
  SPRMVH_MODFOR  
  ,SPRMVH_CODFOR  
  ,SPRMVH_NROFOR  
  ,SPRMVH_FCHMOV  
  ,SPRMVH_TIPCLA  
  ,SPRMVH_CODSUB  
  ,SPRMVH_TIPDES  
  ,SPRMVH_ESTACT  
  ,SPRMVH_TIPHAS  
  ,SPRMVH_ESTNEW  
  ,SPRMVH_CLASIF  
  ,SPRMVH_DESCRP  
  ,SPRMVH_NROCTA  
  ,SPRMVH_FCHREQ  
  ,SPRMVH_FCHLIM  
  ,SPRMVH_NROINT  
  ,SPRMVH_RUBR01  
  ,SPRMVH_APLARE  
  ,SPRMVH_APLCOD  
  ,SPRMVH_PEDARE  
  ,SPRMVH_PEDRES  
  ,SPRMVH_USERNT  
  ,SPRMVH_CODPRI  
  ,SPRMVH_OLEOLE  
  ,SPRMVH_DESFUN  
  ,SPRMVH_NROITM  
  ,SPRMVH_ORIPRO  
  ,SPRMVH_CTACON  
  ,SPRMVH_CONTAC  
  ,SPRMVH_FECALT  
  ,SPRMVH_FECMOD  
  ,SPRMVH_USERID  
  ,SPRMVH_ULTOPR  
  ,SPRMVH_DEBAJA  
  ,SPRMVH_OALIAS  
  ,USR_SPRMVH_TIPGSL  
  ,USR_SPRMVH_PRIGSL  
  ,USR_SPRMVH_OLEPRO  
  ,USR_SPRMVH_MODOBJ  
  ,USR_SPRMVH_CODOBJ  
  ,USR_SPRMVH_CODIMP  
  ,USR_SPRMVH_CODOCU  
  )  
 OUTPUT inserted.SPRMVH_MODFOR  
  ,inserted.SPRMVH_CODFOR  
  ,inserted.SPRMVH_NROFOR  
 INTO @OUT_FCRMVH  
 SELECT 'SP' AS SPRMVH_MODFOR  
  ,@CODFOR AS SPRMVH_CODFOR  
  ,NROFOR AS SPRMVH_NROFOR  
  ,CAST(GETDATE() AS DATE) AS SPRMVH_FCHMOV  
  ,@TIPCLA AS SPRMVH_TIPCLA  
  ,@CODSUB AS SPRMVH_CODSUB  
  ,@TIPCLA AS SPRMVH_TIPDES  
  ,'000' AS SPRMVH_ESTACT  
  ,@TIPCLA AS SPRMVH_TIPHAS  
  ,'000' AS SPRMVH_ESTNEW  
  ,@VERSIO AS SPRMVH_CLASIF  
  ,@DESCRP AS SPRMVH_DESCRP  
  ,UPPER(@NROCTA) AS SPRMVH_NROCTA  
  ,CAST(GETDATE() AS DATE) AS SPRMVH_FCHREQ  
  ,CAST(GETDATE() AS DATE) AS SPRMVH_FCHLIM  
  ,NROFOR AS SPRMVH_NROINT  
  ,@VERSIO AS SPRMVH_RUBR01  
  ,@APLARE AS SPRMVH_APLARE  
  ,@APLCOD AS SPRMVH_APLCOD  
  ,@PEDARE AS SPRMVH_PEDARE  
  ,@PEDRES AS SPRMVH_PEDRES  
  ,@USERNT AS SPRMVH_USERNT  
  ,'C' AS SPRMVH_CODPRI  
  ,@ADJUNT AS SPRMVH_OLEOLE  
  ,@DESCRP AS SPRMVH_DESFUN  
  ,1 AS SPRMVH_NROITM  
  ,'WEB' AS SPRMVH_ORIPRO  
  ,CASE   
   WHEN LEN(@USERID) > 0  
    THEN UPPER(@NROCTA)  
   ELSE ''  
   END AS SPRMVH_CTACON  
  ,@USERID AS SPRMVH_CONTAC  
  ,GETDATE() AS SPRMVH_FECALT  
  ,GETDATE() AS SPRMVH_FECMOD  
  ,'WEB' AS SPRMVH_USERID  
  ,'A' AS SPRMVH_ULTOPR  
  ,'N' AS SPRMVH_DEBAJA  
  ,'SPRMVH' AS SPRMVH_OALIAS  
  ,'0' AS USR_SPRMVH_TIPGSL  
  ,'0' AS USR_SPRMVH_PRIGSL  
  ,CASE   
   WHEN LEN(ISNULL(@ADJUNT, '')) > 0  
    THEN 'S'  
   ELSE 'N'  
   END USR_SPRMVH_OLEPRO  
  ,@MODOBJ USR_SPRMVH_MODOBJ  
  ,@CODOBJ USR_SPRMVH_CODOBJ  
  ,@CODIMP USR_SPRMVH_CODIMP  
  ,@CODOCU USR_SPRMVH_CODOCU  
 FROM @UPDATED_SPCFOR  
  
 INSERT INTO SPRMVI (  
  SPRMVI_MODFOR  
  ,SPRMVI_CODFOR  
  ,SPRMVI_NROFOR  
  ,SPRMVI_NROASG  
  ,SPRMVI_NROITM  
  ,SPRMVI_FCHMOV  
  ,SPRMVI_TIPCLA  
  ,SPRMVI_CODSUB  
  ,SPRMVI_TIPDES  
  ,SPRMVI_ESTACT  
  ,SPRMVI_TIPHAS  
  ,SPRMVI_ESTNEW  
  ,SPRMVI_CLASIF  
  ,SPRMVI_FCHREQ  
  ,SPRMVI_FCHLIM  
  ,SPRMVI_RUBR01  
  ,SPRMVI_APLARE  
  ,SPRMVI_APLCOD  
  ,SPRMVI_PEDARE  
  ,SPRMVI_PEDRES  
  ,SPRMVI_ASGARE  
  ,SPRMVI_ASGRES  
  ,SPRMVI_NROINT  
  ,SPRMVI_USERNT  
  ,SPRMVI_ORIARE  
  ,SPRMVI_ORIRES  
  ,SPRMVI_CODPRI  
  ,SPRMVI_DESFUN  
  ,USR_SPRMVI_MAINOT  
  ,USR_SPRMVI_TIPGSL  
  ,USR_SPRMVI_PRIGSL  
  ,SPRMVI_FECALT  
  ,SPRMVI_FECMOD  
  ,SPRMVI_USERID  
  ,SPRMVI_ULTOPR  
  ,SPRMVI_DEBAJA  
  ,SPRMVI_OALIAS  
  )  
 SELECT 'SP' AS SPRMVI_MODFOR  
  ,@CODFOR AS SPRMVI_CODFOR  
  ,NROFOR AS SPRMVI_NROFOR  
  ,1 AS SPRMVI_NROASG  
  ,1 AS SPRMVI_NROITM  
  ,CAST(GETDATE() AS DATE) AS SPRMVI_FCHMOV  
  ,@TIPCLA AS SPRMVI_TIPCLA  
  ,@CODSUB AS SPRMVI_CODSUB  
  ,@TIPCLA AS SPRMVI_TIPDES  
  ,'000' AS SPRMVI_ESTACT  
  ,@TIPCLA AS SPRMVI_TIPHAS  
  ,'000' AS SPRMVI_ESTNEW  
  ,@VERSIO AS SPRMVI_CLASIF  
  ,CAST(GETDATE() AS DATE) AS SPRMVI_FCHREQ  
  ,CAST(GETDATE() AS DATE) AS SPRMVI_FCHLIM  
  ,@VERSIO AS SPRMVI_RUBR01  
  ,@APLARE AS SPRMVI_APLARE  
  ,@APLCOD AS SPRMVI_APLCOD  
  ,@PEDARE AS SPRMVI_PEDARE  
  ,@PEDRES AS SPRMVI_PEDRES  
  ,@ASGARE AS SPRMVI_ASGARE  
  ,@ASGRES AS SPRMVI_ASGRES  
  ,NROFOR AS SPRMVI_NROINT  
  ,@USERNT AS SPRMVI_USERNT  
  ,@ORIARE AS SPRMVI_ORIARE  
  ,@ORIRES AS SPRMVI_ORIRES  
  ,'C' AS SPRMVI_CODPRI  
  ,@DESCRP AS SPRMVI_DESFUN  
  ,'N' AS USR_SPRMVI_MAINOT  
  ,'0' AS USR_SPRMVI_TIPGSL  
  ,'0' AS USR_SPRMVI_PRIGSL  
  ,GETDATE() AS SPRMVI_FECALT  
  ,GETDATE() AS SPRMVI_FECMOD  
  ,'WEB' AS SPRMVI_USERID  
  ,'A' AS SPRMVI_ULTOPR  
  ,'N' AS SPRMVI_DEBAJA  
  ,'WEB' AS SPRMVI_OALIAS  
 FROM @UPDATED_SPCFOR  
  
 SELECT @NROFOR = NROFOR  
 FROM @OUT_FCRMVH  
  
 EXEC [cwspInsertPlanning] @MODFOR  
  ,@CODFOR  
  ,@NROFOR  
  
 IF LEN(ISNULL(@ADJUNT, '')) > 0  
 BEGIN  
  EXEC [SLSPWEB_ProcessAttachedFiles] @MODFOR  
   ,@CODFOR  
   ,@NROFOR  
 END  
  
 SELECT *  
 FROM @OUT_FCRMVH  
  
 COMMIT TRAN  
END  
  
  